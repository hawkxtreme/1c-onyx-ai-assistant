# Инструкция по первоначальной настройке (Onyx)

## Описание

Обработка **"Помощник первого запуска (Onyx)"** предназначена для первоначальной настройки подключения к API Onyx. Она поможет вам настроить все необходимые параметры для работы с AI-ассистентами.

## Когда запускается помощник

Помощник первого запуска автоматически открывается в следующих случаях:
- При первом запуске обработки "Чаты (Onyx)" без настроек подключения
- При отсутствии записей в регистре сведений `onyx_НастройкиAPI`

**Примечание:** Вы также можете запустить помощник вручную, открыв обработку **"Onyx" → "Помощник первого запуска"**.

## Процесс настройки

Помощник состоит из двух страниц, которые нужно пройти последовательно:

### Страница 1: Настройка подключения к API

На этой странице необходимо указать параметры подключения к Onyx API.

#### 1. Контур

Выберите контур API:
- **Рабочий контур** - для работы с production сервером Onyx
- **Тестовый контур** - для работы с sandbox сервером Onyx

**Рекомендация:** Для первоначальной настройки используйте тестовый контур.

#### 2. API Ключ

Введите API ключ от вашего аккаунта Onyx:
- Для локального развертывания Onyx: ключ генерируется в интерфейсе Onyx (http://localhost:3000)
- Для облачного развертывания: ключ можно получить на https://cloud.onyx.app

**Важно:**
- API ключ должен быть не менее 10 символов
- Сохраните ключ в надежном месте - он отображается только один раз при создании
- Ключ используется для авторизации всех запросов к API

**Где получить API ключ:**
1. Откройте Onyx в браузере (локально или облако)
2. Перейдите в раздел "Settings" → "API Keys"
3. Создайте новый ключ или скопируйте существующий

#### 3. Базовый URL

Введите базовый URL для подключения к API:
- **Для локального развертывания:** `http://localhost:3000/`
- **Для облачного развертывания:** `https://cloud.onyx.app/`

**Важно:**
- URL должен начинаться с `http://` или `https://`
- В конце URL должна быть слэш `/`
- Убедитесь, что сервер Onyx доступен по указанному адресу

#### 4. Таймаут соединения (секунды)

Время ожидания установки соединения с сервером (по умолчанию: 300 секунд).

**Рекомендация:** Для локального развертывания можно уменьшить до 30-60 секунд. Для облачного развертывания оставьте 300 секунд.

#### 5. Таймаут чтения (секунды)

Время ожидания ответа от сервера после установки соединения (по умолчанию: 60 секунд).

**Рекомендация:** Для Ollama на CPU увеличьте до 120-180 секунд, так как ответы могут занимать больше времени.

#### 6. Максимальное количество повторов

Количество попыток повторной отправки запроса при ошибке (по умолчанию: 3).

**Рекомендация:** Оставьте значение по умолчанию для стабильной работы.

#### 7. Максимальное время повторов (секунды)

Максимальное время между попытками повторной отправки (по умолчанию: 5 секунд).

**Рекомендация:** Оставьте значение по умолчанию.

#### 8. Проверка соединения

После заполнения всех полей:
1. Нажмите кнопку **"Проверить соединение"**
2. Дождитесь завершения проверки
3. Если соединение успешно установлено, появится сообщение **"Соединение установлено успешно"**
4. Настройки автоматически сохранятся после успешной проверки

**Важно:** Перед переходом на следующую страницу необходимо успешно пройти проверку соединения.

**Возможные ошибки при проверке:**
- **"Неверный API ключ"** - проверьте правильность ключа
- **"Сервер Onyx временно недоступен"** - проверьте доступность сервера
- **"Не удалось установить соединение"** - проверьте URL и доступность сервера

### Страница 2: Загрузка агентов

На этой странице необходимо загрузить список AI-агентов из вашего аккаунта Onyx.

#### 1. Загрузка агентов

1. Нажмите кнопку **"Загрузить агентов"**
2. Дождитесь завершения загрузки
3. После успешной загрузки появится сообщение с количеством загруженных агентов

**Важно:** Перед завершением настройки необходимо успешно загрузить агентов.

**Что происходит при загрузке:**
- Получение списка агентов из Onyx API
- Сохранение метаданных агентов в справочник `onyx_Агенты`
- Обновление списка доступных агентов

**Примечание:** Если в вашем аккаунте Onyx нет созданных агентов, вы увидите сообщение: "Агенты не найдены в вашем аккаунте Onyx. Вы можете создать их на сайте Onyx."

#### 2. Список загруженных агентов

После загрузки в таблице отображаются все доступные агенты:
- Наименование агента
- Описание агента
- Другие метаданные

**Примечание:** Агенты, отмеченные как "Агент по умолчанию", не будут автоматически выбираться в интерфейсе чатов.

## Навигация по помощнику

### Кнопка "Назад"

- Доступна на странице 2
- Позволяет вернуться на предыдущую страницу
- Не сбрасывает введенные данные

### Кнопка "Далее"

- Доступна на странице 1 после успешной проверки соединения
- Переходит на страницу 2 (Загрузка агентов)
- Блокируется, если проверка соединения не пройдена

### Кнопка "Готово"

- Доступна на странице 2 после успешной загрузки агентов
- Сохраняет все настройки и закрывает помощник
- Блокируется, если агенты не загружены

### Кнопка "Отмена"

- Доступна на всех страницах
- При нажатии появляется вопрос о подтверждении отмены
- При подтверждении помощник закрывается без сохранения изменений

## Сохранение настроек

Настройки автоматически сохраняются:
- После успешной проверки соединения (страница 1)
- После нажатия кнопки "Готово" (страница 2)

**Где сохраняются настройки:**
- В регистре сведений `onyx_НастройкиAPI`
- В константе `onyx_ТекущийКонтурAPI`

## Проверка корректности настройки

После завершения настройки убедитесь, что:

1. ✅ **Соединение успешно проверено** - сообщение "Соединение установлено успешно"
2. ✅ **Агенты загружены** - в списке отображаются агенты из Onyx
3. ✅ **Настройки сохранены** - можно открыть обработку "Чаты" без ошибок

## Решение проблем

### Ошибка "Неверный API ключ"

**Проблема:** При проверке соединения появляется ошибка "Неверный API ключ. Проверьте правильность ключа."

**Решение:**
1. Проверьте правильность скопированного API ключа
2. Убедитесь, что ключ не содержит лишних пробелов
3. Создайте новый ключ в Onyx и попробуйте снова
4. Проверьте, что ключ принадлежит тому же аккаунту, к которому вы подключаетесь

### Ошибка "Сервер Onyx временно недоступен"

**Проблема:** При проверке соединения появляется ошибка о недоступности сервера.

**Решение:**
1. Проверьте, запущен ли сервер Onyx:
   - Для локального развертывания: проверьте Docker контейнеры
   - Для облачного: проверьте доступность https://cloud.onyx.app
2. Проверьте правильность базового URL
3. Проверьте настройки firewall и сетевого подключения
4. Убедитесь, что порты не заблокированы

### Ошибка "Не удалось установить соединение"

**Проблема:** При проверке соединения возникает ошибка соединения.

**Решение:**
1. Проверьте доступность сервера Onyx (попробуйте открыть в браузере)
2. Проверьте настройки прокси, если используете
3. Увеличьте таймаут соединения до 300 секунд
4. Проверьте логи Onyx на наличие ошибок

### Ошибка при загрузке агентов

**Проблема:** При попытке загрузить агентов возникает ошибка.

**Решение:**
1. Убедитесь, что проверка соединения прошла успешно
2. Проверьте, что в вашем аккаунте Onyx созданы агенты
3. Проверьте права доступа API ключа
4. Попробуйте обновить список агентов через кнопку "Загрузить агентов"
5. Проверьте журнал работы с API в регистре `onyx_ЖурналРаботыСAPI`

### Агенты не загружаются

**Проблема:** Сообщение "Агенты не найдены в вашем аккаунте Onyx".

**Решение:**
1. Войдите в Onyx и создайте хотя бы одного агента
2. Нажмите кнопку "Загрузить агентов" снова
3. Проверьте, что используете правильный API ключ

### Не могу перейти на страницу 2

**Проблема:** Кнопка "Далее" неактивна на странице 1.

**Решение:**
1. Убедитесь, что все обязательные поля заполнены
2. Выполните проверку соединения - она обязательна для перехода на следующую страницу
3. Дождитесь успешного завершения проверки соединения

### Настройки не сохраняются

**Проблема:** После нажатия "Готово" настройки не сохраняются.

**Решение:**
1. Убедитесь, что агенты успешно загружены
2. Проверьте права доступа к базе данных
3. Проверьте логи на наличие ошибок
4. Попробуйте сохранить настройки еще раз

## Дополнительные настройки после первоначальной настройки

После завершения первоначальной настройки вы можете:

1. **Изменить настройки подключения:**
   - Откройте обработку "Администрирование (Onyx)"
   - Или вручную измените записи в регистре `onyx_НастройкиAPI`

2. **Обновить список агентов:**
   - В обработке "Чаты" нажмите "Обновить список агентов"
   - Или используйте обработку "Администрирование"

3. **Настроить бота поддержки 1С:**
   - См. раздел "Шаг 5: Настройка бота поддержки 1С" в README.md

## Следующие шаги

После успешной настройки:

1. ✅ Откройте обработку **"Чаты (Onyx)"**
2. ✅ Выберите агента
3. ✅ Создайте первую сессию чата
4. ✅ Начните общение с AI-ассистентом!

Подробная инструкция по работе с чатами: см. `ИНСТРУКЦИЯ_ПО_РАБОТЕ_С_ЧАТАМИ.md`



