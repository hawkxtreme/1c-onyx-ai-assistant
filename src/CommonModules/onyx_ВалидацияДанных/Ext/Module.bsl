
#Область ПрограммныйИнтерфейс

////////////////////////////////////////////////////////////////////////////////
// Публичный программный интерфейс
// Выполняет валидацию текста сообщения перед отправкой в Onyx.
//
// Параметры:
//   ТекстСообщения - Строка - сообщение, подлежащее проверке.
//
// Возвращаемое значение:
//   Массив - строки с описанием ошибок; пустой массив - сообщение валидно.
Функция ВалидироватьСообщение(ТекстСообщения) Экспорт
	
	Ошибки = Новый Массив;
	
	Если ПустаяСтрока(ТекстСообщения) Тогда
		Ошибки.Добавить(НСтр("ru='Сообщение не может быть пустым.'"));
		Возврат Ошибки;
	КонецЕсли;
	
	Если СтрДлина(ТекстСообщения) > МаксимальнаяДлинаСообщения() Тогда
		Сообщение = НСтр("ru='Превышена максимальная длина сообщения (%1 символов).'");
		Сообщение = СтрЗаменить(Сообщение, "%1", Строка(МаксимальнаяДлинаСообщения()));
		Ошибки.Добавить(Сообщение);
	КонецЕсли;
	
	Если Не СтрокаВКодировкеUTF8(ТекстСообщения) Тогда
		Ошибки.Добавить(НСтр("ru='Сообщение должно быть в кодировке UTF-8.'"));
	КонецЕсли;
	
	Возврат Ошибки;
	
КонецФункции

// Проверяет корректность идентификатора сессии (UUID).
//
// Параметры:
//   ИдентификаторСессии - Строка - текстовое представление UUID.
//
// Возвращаемое значение:
//   Булево - Истина, если значение является UUID; иначе Ложь.
Функция ВалидироватьИдентификаторСессии(ИдентификаторСессии) Экспорт
	
	Если Не ЗначениеЗаполнено(ИдентификаторСессии) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Возврат ЭтоUUID(ИдентификаторСессии);
	
КонецФункции

// Проверяет корректность идентификатора агента (неотрицательное число).
//
// Параметры:
//   ИдентификаторАгента - Число - идентификатор агента Onyx (строковое значение приводится к числу).
//
// Возвращаемое значение:
//   Булево - Истина, если идентификатор корректен; иначе Ложь.
Функция ВалидироватьИдентификаторАгента(ИдентификаторАгента) Экспорт
	
	Если ТипЗнч(ИдентификаторАгента) = Тип("Число") Тогда
		Возврат ИдентификаторАгента >= 0;
	ИначеЕсли ТипЗнч(ИдентификаторАгента) = Тип("Строка") Тогда
		СтроковыйИдентификатор = СокрЛП(ИдентификаторАгента);
		
		Если Не СтрСоответствуетРегулярномуВыражению(СтроковыйИдентификатор, "^\d+$") Тогда
			Возврат Ложь;
		КонецЕсли;
		
		ЧисловоеЗначение = Число(СтроковыйИдентификатор);
		Возврат ЧисловоеЗначение >= 0;
	Иначе
		Возврат Ложь;
	КонецЕсли;
	
КонецФункции

// Выполняет комплексную проверку данных запроса на создание сессии.
//
// Параметры:
//   ДанныеЗапроса - Структура - поля запроса на создание сессии.
//
// Возвращаемое значение:
//   Массив - строки с описанием найденных ошибок.
Функция ВалидироватьДанныеСозданияСессии(ДанныеЗапроса) Экспорт
	
	Ошибки = Новый Массив;
	
	Если ТипЗнч(ДанныеЗапроса) <> Тип("Структура") Тогда
		Ошибки.Добавить(НСтр("ru='Данные запроса должны быть структурой.'"));
		Возврат Ошибки;
	КонецЕсли;
	
	Если Не ДанныеЗапроса.Свойство("persona_id") Тогда
		Ошибки.Добавить(НСтр("ru='Не указан идентификатор агента (persona_id).'"));
	Иначе
		Если Не ВалидироватьИдентификаторАгента(ДанныеЗапроса.persona_id) Тогда
			Ошибки.Добавить(НСтр("ru='Некорректный идентификатор агента (persona_id).'"));
		КонецЕсли;
	КонецЕсли;
	
	Если ДанныеЗапроса.Свойство("description") И ЗначениеЗаполнено(ДанныеЗапроса.description) Тогда
		Если СтрДлина(ДанныеЗапроса.description) > МаксимальнаяДлинаОписанияСессии() Тогда
			Сообщение = НСтр("ru='Описание сессии не должно превышать %1 символов.'");
			Сообщение = СтрЗаменить(Сообщение, "%1", Строка(МаксимальнаяДлинаОписанияСессии()));
			Ошибки.Добавить(Сообщение);
		КонецЕсли;
	КонецЕсли;
	
	Возврат Ошибки;
	
КонецФункции

#КонецОбласти

#Область СлужебныйПрограммныйИнтерфейс

////////////////////////////////////////////////////////////////////////////////
// Вспомогательный программный интерфейс

// Проверяет возможность преобразования строки в UUID.
//
// Параметры:
//   Значение - Строка - проверяемое значение.
//
// Возвращаемое значение:
//   Булево - Истина, если значение соответствует типу UUID; иначе Ложь.
Функция ЭтоUUID(Значение) Экспорт
	
	Если ТипЗнч(Значение) = Тип("УникальныйИдентификатор") Тогда
		Возврат Истина;
	КонецЕсли;
	
	Если ТипЗнч(Значение) <> Тип("Строка") Тогда
		Возврат Ложь;
	КонецЕсли;
	
	УИД = Неопределено;
	Попытка
		УИД = Новый УникальныйИдентификатор(Значение);
	Исключение
		Возврат Ложь;
	КонецПопытки;
	
	Возврат ТипЗнч(УИД) = Тип("УникальныйИдентификатор");
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

////////////////////////////////////////////////////////////////////////////////
// Частные процедуры и функции

Функция СтрокаВКодировкеUTF8(ЗначениеСтроки)
	
	Если ТипЗнч(ЗначениеСтроки) <> Тип("Строка") Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Попытка
		Данные = Новый ЗаписьJSON;
		Данные.УстановитьСтроку();
		ЗаписатьJSON(Данные, ЗначениеСтроки);
	Исключение
		Возврат Ложь;
	КонецПопытки;
	
	Возврат Истина;
	
КонецФункции

Функция СтрСоответствуетРегулярномуВыражению(Текст, Шаблон)
	
	Если ПустаяСтрока(Текст) Тогда
		Возврат Ложь;
	КонецЕсли;

	Если Шаблон = "^\d+$" Тогда
		Возврат СтрокаСодержитТолькоЦифры(Текст);
	ИначеЕсли Шаблон = "^-?\d+$" Тогда
		Возврат СтрокаСоответствуетЦеломуСЗнаком(Текст);
	Иначе
		Возврат Ложь;
	КонецЕсли;
	
КонецФункции

Функция СтрокаСодержитТолькоЦифры(ЗначениеСтроки)

	Если ПустаяСтрока(ЗначениеСтроки) Тогда
		Возврат Ложь;
	КонецЕсли;

	Для Индекс = 1 По СтрДлина(ЗначениеСтроки) Цикл
		Символ = Сред(ЗначениеСтроки, Индекс, 1);
		Если Символ < "0" ИЛИ Символ > "9" Тогда
			Возврат Ложь;
		КонецЕсли;
	КонецЦикла;

	Возврат Истина;

КонецФункции

Функция СтрокаСоответствуетЦеломуСЗнаком(ЗначениеСтроки)

	Если ПустаяСтрока(ЗначениеСтроки) Тогда
		Возврат Ложь;
	КонецЕсли;

	Если Лев(ЗначениеСтроки, 1) = "-" Тогда
		Если СтрДлина(ЗначениеСтроки) = 1 Тогда
			Возврат Ложь;
		КонецЕсли;
		НачальнаяПозицияПослеЗнакаМинус = НачальнаяПозицияПослеЗнакаМинус();
		Возврат СтрокаСодержитТолькоЦифры(Сред(ЗначениеСтроки, НачальнаяПозицияПослеЗнакаМинус));
	КонецЕсли;

	Возврат СтрокаСодержитТолькоЦифры(ЗначениеСтроки);

КонецФункции

Функция МаксимальнаяДлинаСообщения()
	
	Возврат 100000;
	
КонецФункции

Функция МаксимальнаяДлинаОписанияСессии()
	
	Возврат 500;
	
КонецФункции

// Возвращает начальную позицию для извлечения подстроки после знака минус.
//
// Возвращаемое значение:
//   Число - позиция начала подстроки после знака минус (2).
Функция НачальнаяПозицияПослеЗнакаМинус()
	
	Возврат 2;
	
КонецФункции

#КонецОбласти
